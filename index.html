<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Калькулятор</title>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Ubuntu Mono', monospace;
            background: #ffffff;
            color: #000000;
            overflow: hidden;
            touch-action: pan-y;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 8px;
            gap: 8px;
        }

        /* Display */
        .display-container {
            flex: 1;
            background: #f8f9fa;
            border-radius: 24px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            min-height: 120px;
            position: relative;
        }

        .memory-indicator {
            position: absolute;
            top: 12px;
            left: 20px;
            font-size: 12px;
            color: #666;
        }

        .expression {
            font-size: 16px;
            color: #666;
            margin-bottom: 12px;
            word-wrap: break-word;
            overflow-x: auto;
            white-space: nowrap;
        }

        .result {
            font-size: 32px;
            font-weight: 700;
            color: #000000;
            text-align: right;
            word-wrap: break-word;
            overflow-x: auto;
        }

        /* Mode Tabs */
        .mode-tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 20px;
            padding: 4px;
            gap: 4px;
        }

        .mode-tab {
            flex: 1;
            padding: 12px 8px;
            background: transparent;
            border: none;
            color: #000000;
            font-size: 12px;
            cursor: pointer;
            border-radius: 16px;
            transition: all 0.2s;
            font-family: 'Ubuntu Mono', monospace;
        }

        .mode-tab.active {
            background: #000000;
            color: #ffffff;
            font-weight: 700;
        }

        /* Content Area */
        .content-area {
            flex: 3;
            overflow: hidden;
            position: relative;
        }

        .mode-content {
            display: none;
            height: 100%;
            overflow-y: auto;
        }

        .mode-content.active {
            display: flex;
            flex-direction: column;
        }

        /* Calculator Keyboard */
        .calculator-keyboard {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            padding: 8px;
        }

        .calc-btn {
            background: #000000;
            border: none;
            border-radius: 50%;
            color: #ffffff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1;
            font-family: 'Ubuntu Mono', monospace;
            font-weight: 700;
        }

        .calc-btn:active {
            background: #333333;
            transform: scale(0.95);
        }

        .calc-btn.operator {
            background: #2d2d2d;
        }

        .calc-btn.function {
            background: #404040;
            font-size: 14px;
        }

        .calc-btn.memory {
            background: #505050;
            font-size: 12px;
        }

        .calc-btn.equals {
            background: #000000;
        }

        .calc-btn.clear {
            background: #404040;
        }

        /* Advanced Functions Panel */
        .advanced-panel {
            background: #f8f9fa;
            padding: 12px;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            border-radius: 20px;
            margin: 8px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .advanced-panel.open {
            max-height: 300px;
        }

        .adv-btn {
            background: #000000;
            border: none;
            padding: 12px 8px;
            font-size: 12px;
            border-radius: 16px;
            cursor: pointer;
            color: #ffffff;
            transition: all 0.2s;
            font-family: 'Ubuntu Mono', monospace;
        }

        .adv-btn:active {
            background: #333333;
        }

        /* Mode Selection Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #ffffff;
            border-radius: 20px;
            padding: 24px;
            max-width: 90%;
            max-height: 80%;
            overflow-y: auto;
            border: 2px solid #000000;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #000000;
            text-align: center;
        }

        .mode-option {
            padding: 16px;
            margin: 8px 0;
            background: #f8f9fa;
            border: 2px solid #000000;
            border-radius: 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-family: 'Ubuntu Mono', monospace;
            font-weight: 700;
        }

        .mode-option:hover, .mode-option.active {
            background: #000000;
            color: #ffffff;
        }

        .mode-description {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .app-container {
                max-width: 400px;
                margin: 0 auto;
            }
        }

        @media (orientation: landscape) and (max-height: 500px) {
            .display-container {
                min-height: 80px;
                padding: 12px;
            }
            
            .result {
                font-size: 24px;
            }
            
            .calculator-keyboard {
                grid-template-columns: repeat(6, 1fr);
                gap: 6px;
                padding: 6px;
            }
            
            .calc-btn {
                font-size: 14px;
            }
        }

        /* Special modes */
        .calculator-keyboard.beginner {
            grid-template-columns: repeat(4, 1fr);
        }

        .calculator-keyboard.beginner .calc-btn {
            font-size: 20px;
            min-height: 70px;
        }

        .calculator-keyboard.ovz {
            grid-template-columns: repeat(3, 1fr);
        }

        .calculator-keyboard.ovz .calc-btn {
            font-size: 24px;
            min-height: 80px;
            border-radius: 20px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Display -->
        <div class="display-container">
            <div class="memory-indicator" id="memoryIndicator">M</div>
            <div class="expression" id="expression"></div>
            <div class="result" id="result">0</div>
        </div>

        <!-- Mode Tabs -->
        <div class="mode-tabs">
            <button class="mode-tab active" data-mode="calculator">простой</button>
            <button class="mode-tab" data-mode="fractions">дроби</button>
            <button class="mode-tab" data-mode="memory">мемори</button>
            <button class="mode-tab" data-mode="solver">решалка</button>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Calculator Mode -->
            <div class="mode-content active" id="calculator-mode">
                <!-- Memory Panel -->
                <div class="memory-panel" id="memoryPanel">
                    <div class="memory-grid" id="memoryGrid">
                        <!-- Memory cells will be generated here -->
                    </div>
                </div>

                <!-- Advanced Functions Panel -->
                <div class="advanced-panel" id="advancedPanel">
                    <button class="adv-btn" data-func="sin">sin</button>
                    <button class="adv-btn" data-func="cos">cos</button>
                    <button class="adv-btn" data-func="tan">tan</button>
                    <button class="adv-btn" data-func="sin⁻¹">sin⁻¹</button>
                    <button class="adv-btn" data-func="cos⁻¹">cos⁻¹</button>
                    
                    <button class="adv-btn" data-func="sinh">sinh</button>
                    <button class="adv-btn" data-func="cosh">cosh</button>
                    <button class="adv-btn" data-func="tanh">tanh</button>
                    <button class="adv-btn" data-func="log">log</button>
                    <button class="adv-btn" data-func="ln">ln</button>
                    
                    <button class="adv-btn" data-func="√">√</button>
                    <button class="adv-btn" data-func="³√">³√</button>
                    <button class="adv-btn" data-func="x²">x²</button>
                    <button class="adv-btn" data-func="x³">x³</button>
                    <button class="adv-btn" data-func="x^y">x^y</button>
                    
                    <button class="adv-btn" data-func="π">π</button>
                    <button class="adv-btn" data-func="e">e</button>
                    <button class="adv-btn" data-func="nCr">nCr</button>
                    <button class="adv-btn" data-func="nPr">nPr</button>
                    <button class="adv-btn" data-func="hyp">hyp</button>
                    
                    <button class="adv-btn" data-func="Pol(">Pol(</button>
                    <button class="adv-btn" data-func="Rec(">Rec(</button>
                    <button class="adv-btn" data-func="S⇄D">S⇄D</button>
                    <button class="adv-btn" data-func="(--)">(--)</button>
                    <button class="adv-btn" data-func="Ans">Ans</button>
                </div>

                <!-- Calculator Keyboard -->
                <div class="calculator-keyboard" id="mainKeyboard">
                    <button class="calc-btn memory" data-action="mc">MC</button>
                    <button class="calc-btn memory" data-action="mr">MR</button>
                    <button class="calc-btn memory" data-action="m+">M+</button>
                    <button class="calc-btn memory" data-action="m-">M-</button>
                    <button class="calc-btn clear" data-action="clear">C</button>

                    <button class="calc-btn function" data-action="backspace">⌫</button>
                    <button class="calc-btn function" data-action="percent">%</button>
                    <button class="calc-btn function" data-action="sqrt">√</button>
                    <button class="calc-btn function" data-action="power">x²</button>
                    <button class="calc-btn operator" data-action="divide">/</button>

                    <button class="calc-btn" data-value="7">7</button>
                    <button class="calc-btn" data-value="8">8</button>
                    <button class="calc-btn" data-value="9">9</button>
                    <button class="calc-btn function" data-action="memory-toggle">M</button>
                    <button class="calc-btn operator" data-action="multiply">×</button>

                    <button class="calc-btn" data-value="4">4</button>
                    <button class="calc-btn" data-value="5">5</button>
                    <button class="calc-btn" data-value="6">6</button>
                    <button class="calc-btn function" data-action="advanced-toggle">f(x)</button>
                    <button class="calc-btn operator" data-action="subtract">−</button>

                    <button class="calc-btn" data-value="1">1</button>
                    <button class="calc-btn" data-value="2">2</button>
                    <button class="calc-btn" data-value="3">3</button>
                    <button class="calc-btn function" data-action="alpha">A</button>
                    <button class="calc-btn operator" data-action="add">+</button>

                    <button class="calc-btn function" data-action="negate">(-)</button>
                    <button class="calc-btn" data-value="0">0</button>
                    <button class="calc-btn" data-value=".">,</button>
                    <button class="calc-btn function" data-action="fraction">a b/c</button>
                    <button class="calc-btn equals" data-action="equals">=</button>
                </div>
            </div>

            <!-- Other modes remain the same -->
            <div class="mode-content" id="fractions-mode">
                <div style="padding: 20px; text-align: center;">
                    <h3>Режим дробей</h3>
                    <p>Переключитесь в расширенный режим для работы с дробями</p>
                </div>
            </div>

            <div class="mode-content" id="memory-mode">
                <div style="padding: 20px; text-align: center;">
                    <h3>Режим памяти</h3>
                    <p>Переключитесь в расширенный режим для работы с памятью</p>
                </div>
            </div>

            <div class="mode-content" id="solver-mode">
                <div style="padding: 20px; text-align: center;">
                    <h3>Режим решателя</h3>
                    <p>Переключитесь в расширенный режим для решения уравнений</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Mode Selection Modal -->
    <div class="modal" id="modeModal">
        <div class="modal-content">
            <div class="modal-header">Выберите режим</div>
            <div class="mode-option" data-mode="beginner">
                Начальная школа
                <div class="mode-description">Большие кнопки, только основы</div>
            </div>
            <div class="mode-option" data-mode="middle">
                Средняя школа
                <div class="mode-description">Дроби, проценты, степени</div>
            </div>
            <div class="mode-option" data-mode="gia">
                ГИА подготовка
                <div class="mode-description">Все для экзамена 9 класс</div>
            </div>
            <div class="mode-option" data-mode="ovz">
                ОВЗ
                <div class="mode-description">Особые образовательные потребности</div>
            </div>
            <div class="mode-option active" data-mode="balance">
                Баланс (рекомендуется)
                <div class="mode-description">Оптимальный набор функций</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
    <script>
        class Calculator {
            constructor() {
                this.expression = '';
                this.result = '0';
                this.memory = Array(100).fill(null);
                this.currentMemory = 0;
                this.alphaMode = false;
                this.lastAnswer = null;
                this.currentMode = 'balance';
                this.initializeElements();
                this.attachEventListeners();
                this.setupModeSelection();
                this.updateKeyboardForMode();
            }

            initializeElements() {
                this.expressionDisplay = document.getElementById('expression');
                this.resultDisplay = document.getElementById('result');
                this.advancedPanel = document.getElementById('advancedPanel');
                this.memoryPanel = document.getElementById('memoryPanel');
                this.memoryIndicator = document.getElementById('memoryIndicator');
                this.mainKeyboard = document.getElementById('mainKeyboard');
                this.modeModal = document.getElementById('modeModal');
            }

            setupModeSelection() {
                let holdTimer;
                const simpleTab = document.querySelector('[data-mode="calculator"]');
                
                simpleTab.addEventListener('touchstart', (e) => {
                    holdTimer = setTimeout(() => {
                        this.modeModal.classList.add('active');
                    }, 2000);
                });

                simpleTab.addEventListener('touchend', () => {
                    clearTimeout(holdTimer);
                });

                simpleTab.addEventListener('click', (e) => {
                    if (!this.isLongPress) {
                        // Regular click handling
                    }
                    this.isLongPress = false;
                });

                // Mode selection in modal
                document.querySelectorAll('.mode-option').forEach(option => {
                    option.addEventListener('click', () => {
                        this.currentMode = option.dataset.mode;
                        this.updateKeyboardForMode();
                        this.modeModal.classList.remove('active');
                        
                        // Update active state
                        document.querySelectorAll('.mode-option').forEach(opt => {
                            opt.classList.remove('active');
                        });
                        option.classList.add('active');
                    });
                });

                // Close modal on background click
                this.modeModal.addEventListener('click', (e) => {
                    if (e.target === this.modeModal) {
                        this.modeModal.classList.remove('active');
                    }
                });
            }

            updateKeyboardForMode() {
                // Remove all existing classes
                this.mainKeyboard.className = 'calculator-keyboard';
                
                // Add mode-specific class
                this.mainKeyboard.classList.add(this.currentMode);

                // Update button visibility based on mode
                const buttons = this.mainKeyboard.querySelectorAll('.calc-btn');
                buttons.forEach(btn => {
                    const action = btn.dataset.action;
                    const value = btn.dataset.value;
                    
                    switch(this.currentMode) {
                        case 'beginner':
                            // Only show basic buttons
                            if (action && !['clear', 'backspace', 'equals', 'add', 'subtract', 'multiply', 'divide'].includes(action)) {
                                btn.style.display = 'none';
                            } else if (!value && !action) {
                                btn.style.display = 'none';
                            } else {
                                btn.style.display = 'flex';
                            }
                            break;
                            
                        case 'ovz':
                            // Extra large buttons, simplified layout
                            btn.style.display = 'flex';
                            break;
                            
                        case 'middle':
                            // Show basic + fractions + percentages
                            if (action && ['memory-toggle', 'advanced-toggle', 'alpha', 'fraction'].includes(action)) {
                                btn.style.display = 'none';
                            } else {
                                btn.style.display = 'flex';
                            }
                            break;
                            
                        case 'gia':
                            // Show all functions needed for GIA
                            btn.style.display = 'flex';
                            break;
                            
                        case 'balance':
                        default:
                            // Show balanced set
                            btn.style.display = 'flex';
                            break;
                    }
                });
            }

            attachEventListeners() {
                // Mode tabs
                document.querySelectorAll('.mode-tab').forEach(tab => {
                    tab.addEventListener('click', () => this.switchMode(tab.dataset.mode));
                });

                // Calculator buttons
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('calc-btn')) {
                        const value = e.target.dataset.value;
                        const action = e.target.dataset.action;

                        if (value !== undefined) {
                            this.appendValue(value);
                        } else if (action) {
                            this.handleAction(action);
                        }
                    }
                });

                // Advanced function buttons
                document.querySelectorAll('.adv-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.insertFunction(btn.dataset.func);
                    });
                });
            }

            switchMode(mode) {
                document.querySelectorAll('.mode-tab').forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.mode === mode);
                });

                document.querySelectorAll('.mode-content').forEach(content => {
                    content.classList.remove('active');
                });

                document.getElementById(`${mode}-mode`).classList.add('active');
            }

            appendValue(value) {
                if (this.result !== '0' && this.expression === '') {
                    this.expression = this.result;
                }
                
                if (this.alphaMode) {
                    this.expression += String.fromCharCode(65 + parseInt(value));
                } else {
                    this.expression += value;
                }
                this.updateDisplay();
            }

            handleAction(action) {
                switch(action) {
                    case 'clear':
                        this.expression = '';
                        this.result = '0';
                        break;
                    case 'backspace':
                        this.expression = this.expression.slice(0, -1);
                        break;
                    case 'equals':
                        this.calculate();
                        return;
                    case 'add':
                        this.expression += '+';
                        break;
                    case 'subtract':
                        this.expression += '-';
                        break;
                    case 'multiply':
                        this.expression += '*';
                        break;
                    case 'divide':
                        this.expression += '/';
                        break;
                    case 'percent':
                        this.expression += '/100';
                        break;
                    case 'sqrt':
                        // Use proper root symbol and handle display
                        this.expression += '√(';
                        break;
                    case 'power':
                        this.expression += '^2';
                        break;
                    case 'advanced-toggle':
                        this.advancedPanel.classList.toggle('open');
                        break;
                    case 'memory-toggle':
                        this.memoryPanel.classList.toggle('open');
                        break;
                    case 'alpha':
                        this.alphaMode = !this.alphaMode;
                        break;
                    case 'negate':
                        this.expression += '*(-1)';
                        break;
                    case 'fraction':
                        this.switchMode('fractions');
                        return;
                    case 'mc':
                        this.memory[this.currentMemory] = null;
                        this.updateMemoryIndicator();
                        break;
                    case 'mr':
                        if (this.memory[this.currentMemory] !== null) {
                            this.expression += this.memory[this.currentMemory];
                            this.updateDisplay();
                        }
                        break;
                    case 'm+':
                        this.calculate();
                        if (this.result !== 'Error') {
                            const currentValue = this.memory[this.currentMemory] || 0;
                            this.memory[this.currentMemory] = currentValue + parseFloat(this.result);
                            this.updateMemoryIndicator();
                        }
                        break;
                    case 'm-':
                        this.calculate();
                        if (this.result !== 'Error') {
                            const currentValue = this.memory[this.currentMemory] || 0;
                            this.memory[this.currentMemory] = currentValue - parseFloat(this.result);
                            this.updateMemoryIndicator();
                        }
                        break;
                }
                this.updateDisplay();
            }

            insertFunction(func) {
                const functions = {
                    'sin': 'sin(',
                    'cos': 'cos(',
                    'tan': 'tan(',
                    'sin⁻¹': 'asin(',
                    'cos⁻¹': 'acos(',
                    'sinh': 'sinh(',
                    'cosh': 'cosh(',
                    'tanh': 'tanh(',
                    'log': 'log10(',
                    'ln': 'log(',
                    '√': '√(',
                    '³√': 'cbrt(',
                    'x²': '^2',
                    'x³': '^3',
                    'x^y': '^',
                    'π': 'pi',
                    'e': 'e',
                    'nCr': this.insertCombinatorics.bind(this, 'comb'),
                    'nPr': this.insertCombinatorics.bind(this, 'perm'),
                    'hyp': this.insertHyp.bind(this),
                    'Pol(': 'Pol(',
                    'Rec(': 'Rec(',
                    'S⇄D': this.switchDecimalFraction.bind(this),
                    '(--)': '*(-1)',
                    'Ans': this.insertAnswer.bind(this)
                };

                if (functions[func]) {
                    if (typeof functions[func] === 'function') {
                        functions[func]();
                    } else {
                        this.expression += functions[func];
                    }
                }
                this.updateDisplay();
            }

            insertCombinatorics(type) {
                this.expression += type === 'comb' ? 'combinations(' : 'permutations(';
            }

            insertHyp() {
                this.expression += 'sqrt(x^2+y^2)';
            }

            insertAnswer() {
                if (this.lastAnswer !== null) {
                    this.expression += this.lastAnswer.toString();
                }
            }

            switchDecimalFraction() {
                if (this.result.includes('/')) {
                    const parts = this.result.split('/');
                    const decimal = parseFloat(parts[0]) / parseFloat(parts[1]);
                    this.result = this.formatNumber(decimal);
                } else {
                    const decimal = parseFloat(this.result);
                    const fraction = this.decimalToFraction(decimal);
                    this.result = `${fraction[0]}/${fraction[1]}`;
                }
                this.updateDisplay();
            }

            decimalToFraction(decimal) {
                const tolerance = 1.0E-6;
                let numerator = 1;
                let denominator = 1;
                let fraction = numerator / denominator;
                
                while (Math.abs(fraction - decimal) > tolerance) {
                    if (fraction < decimal) {
                        numerator++;
                    } else {
                        denominator++;
                        numerator = Math.round(decimal * denominator);
                    }
                    fraction = numerator / denominator;
                }
                return [numerator, denominator];
            }

            calculate() {
                try {
                    let expr = this.expression;
                    
                    // Handle root symbol display but use sqrt for calculation
                    expr = expr.replace(/√/g, 'sqrt');
                    expr = expr.replace(/,/g, '.');
                    
                    const result = math.evaluate(expr);
                    this.lastAnswer = result;
                    this.result = this.formatNumber(result);
                    this.expression = '';
                } catch (error) {
                    this.result = 'Ошибка';
                    setTimeout(() => {
                        this.result = '0';
                        this.updateDisplay();
                    }, 2000);
                }
                this.updateDisplay();
            }

            formatNumber(num) {
                if (Math.abs(num) < 1e-10) return '0';
                if (Math.abs(num) > 1e10 || Math.abs(num) < 1e-4) {
                    return num.toExponential(6).replace(/\./g, ',');
                }
                return parseFloat(num.toFixed(6)).toString().replace(/\./g, ',');
            }

            updateDisplay() {
                // Use root symbol in display but keep sqrt for calculation
                let displayExpr = this.expression.replace(/sqrt/g, '√');
                this.expressionDisplay.textContent = displayExpr || '';
                this.resultDisplay.textContent = this.result;
            }

            updateMemoryIndicator() {
                const usedCount = this.memory.filter(cell => cell !== null).length;
                this.memoryIndicator.textContent = usedCount > 0 ? `M[${usedCount}]` : 'M';
            }
        }

        // Инициализация калькулятора
        document.addEventListener('DOMContentLoaded', () => {
            window.calculator = new Calculator();
        });
    </script>
</body>
</html>
